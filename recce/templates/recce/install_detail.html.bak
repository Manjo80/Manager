{% extends "base.html" %}
{% load static %}

{% block title %}{{ install.title }}{% endblock %}

{% block content %}

{# fv MUSS vor dem Markieren-Link existieren #}
{% with fv=install.fixed_views.first %}

<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <div class="text-muted small">Einbaumöglichkeit</div>
    <h1 class="h4 m-0">{{ install.title }}</h1>
    <div class="text-muted small">
      <a href="{% url 'recce:vehicle_detail' install.vehicle.pk %}">{{ install.vehicle }}</a>
      {% if install.created_by %} • von {{ install.created_by.username }}{% endif %}
      {% if install.created_at %} • {{ install.created_at|date:"Y-m-d H:i" }}{% endif %}
    </div>
  </div>

  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary btn-sm" href="{% url 'recce:vehicle_detail' install.vehicle.pk %}">Zurück</a>
    <a class="btn btn-outline-primary btn-sm" href="{% url 'recce:install_edit' install.pk %}">Bearbeiten</a>

    {# Nur anzeigen, wenn fv wirklich existiert und eine PK hat #}
    {% if fv and fv.pk %}
      <a class="btn btn-outline-secondary btn-sm mt-2" href="{% url 'recce:fixed_markers' fv.pk %}">Markieren</a>
    {% endif %}
  </div>
</div>

{% if install.description %}
  <div class="card card-body mb-3">{{ install.description|linebreaksbr }}</div>
{% endif %}

<div class="row g-2 mb-3">
  <div class="col-6 col-md-3">
    <div class="card">
      <div class="card-body py-2">
        <div class="text-muted small">Risiko</div>
        <div class="fw-semibold">{% if install.risk_level %}{{ install.risk_level.label }}{% else %}-{% endif %}</div>
      </div>
    </div>
  </div>

  <div class="col-6 col-md-3">
    <div class="card">
      <div class="card-body py-2">
        <div class="text-muted small">Zeit</div>
        <div class="fw-semibold">{% if install.effort_minutes %}{{ install.effort_minutes }} min{% else %}-{% endif %}</div>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-6">
    <div class="card">
      <div class="card-body py-2">
        <div class="text-muted small">Tools</div>
        {% for t in install.tools.all %}
          <span class="chip">{{ t.name }}</span>
        {% empty %}
          <span class="text-muted small">-</span>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<div class="d-flex align-items-center justify-content-between mb-2">
  <div class="fw-semibold">Max-Kombos pro Sender</div>
  <a class="btn btn-sm btn-primary" href="{% url 'recce:setup_upsert' install.pk %}">Neu</a>
</div>

<div class="list-group mb-3">
  {% for s in install.max_setups.all %}
    <div class="list-group-item">
      <div class="d-flex justify-content-between">
        <div>
          <div class="fw-semibold">{{ s.sender_model.name }}</div>
          <div class="text-muted small">
            {{ s.get_power_mode_display }}
            {% if s.max_battery_config %} • {{ s.max_battery_config.name }}{% endif %}
          </div>
          {% if s.notes %}<div class="small">{{ s.notes }}</div>{% endif %}
        </div>
        <a class="btn btn-outline-danger btn-sm" href="{% url 'recce:setup_delete' s.pk %}">Löschen</a>
      </div>
    </div>
  {% empty %}
    <div class="text-muted">Keine Max-Kombos.</div>
  {% endfor %}
</div>

<div class="d-flex align-items-center justify-content-between mb-2">
  <div class="fw-semibold">Fotos</div>
  <a class="btn btn-sm btn-primary" href="{% url 'recce:install_photo_new' install.pk %}">Foto hinzufügen</a>
</div>

<div class="row g-2 mb-3">
  {% for p in install.photos.all %}
    <div class="col-12 col-md-4">
      <div class="card">
        <img class="img-thumb" src="{{ p.image.url }}" alt="" data-enlarge="1" style="cursor:zoom-in;">
        <div class="card-body py-2">
          <div class="small">{{ p.caption|default:"" }}</div>
          <div class="mt-2 d-flex gap-2">
            <a class="btn btn-outline-danger btn-sm" href="{% url 'recce:install_photo_markers' p.pk %}">Markieren</a>
            <a class="btn btn-outline-danger btn-sm" href="{% url 'recce:install_photo_delete' p.pk %}">Löschen</a>
          </div>
        </div>
      </div>
    </div>
  {% empty %}
    <div class="text-muted">Keine Fotos.</div>
  {% endfor %}
</div>

<hr class="my-4">

{# BONUS-FIX: NICHT fv überschreiben -> Liste heißt fvs #}
{% with fvs=install.fixed_views.all|dictsort:"view_type" %}

<div class="d-flex align-items-center justify-content-between mb-2">
  <div class="fw-semibold">Standardansichten (Fix)</div>
</div>

<div class="row g-2">
  {% for fixed in fvs %}
    <div class="col-12 col-md-6">
      <div class="card">
        <div class="card-body py-2 d-flex align-items-center justify-content-between">
          <div class="fw-semibold">{{ fixed.get_view_type_display|default:fixed.view_type }}</div>
          <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary btn-sm" href="{% url 'recce:fixed_edit' install.pk fixed.view_type %}">Bearbeiten</a>
            <a class="btn btn-outline-secondary btn-sm" href="{% url 'recce:fixed_markers' fixed.pk %}">Markieren</a>
          </div>
        </div>

        {# Wenn du die fixen Bilder wirklich als statische Dateien nutzt: #}
        <div class="p-2">
          {% if fixed.view_type == "front" %}
            <img class="img-thumb" src="{% static 'recce/fixed/front.png' %}" alt="front" data-enlarge="1" style="cursor:zoom-in;">
          {% elif fixed.view_type == "rear" %}
            <img class="img-thumb" src="{% static 'recce/fixed/rear.png' %}" alt="rear" data-enlarge="1" style="cursor:zoom-in;">
          {% elif fixed.view_type == "side" %}
            <img class="img-thumb" src="{% static 'recce/fixed/side.png' %}" alt="side" data-enlarge="1" style="cursor:zoom-in;">
          {% elif fixed.view_type == "top" %}
            <img class="img-thumb" src="{% static 'recce/fixed/top.png' %}" alt="top" data-enlarge="1" style="cursor:zoom-in;">
          {% else %}
            <div class="text-muted small">Unbekannte Ansicht: {{ fixed.view_type }}</div>
          {% endif %}
        </div>
      </div>
    </div>
  {% empty %}
    <div class="text-muted">Keine Standardansichten vorhanden.</div>
  {% endfor %}
</div>

{% endwith %} {# fvs #}

{% endwith %} {# fv #}

{% endblock %}
